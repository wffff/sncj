<!--suppress ThymeleafVariablesResolveInspection -->
<html th:if="${tab.url == 'permission'}" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">

<div id="user">
    <div class="inSearch">
        <div class="allSearch">
            <div class="layui-inline">
                <input name="name" required="" lay-verify="required"
                       placeholder="用户名称" autocomplete="off" class="layui-input input-qu">
            </div>
        </div>
        <div class="layui-input-inline right">
            <button sec:authorize="hasRole('ROLE_TEST')" class="layui-btn layui-btn-sm layui-btn-primary"
                    data-type="userReload">查询
            </button>
        </div>
    </div>
</div>
<script type="text/html" id="oper-col">
    <a class="layui-btn layui-btn layui-btn-xs" lay-event="addChild">新增子项</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<table class="page-table" th:id="${tab.url}" th:attr="lay-filter=${tab.url}"></table>

<script>
    layui.use(['layer', 'table', 'treetable', 'jquery', 'form'], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var form = layui.form;
        var treetable = layui.treetable;
        var layer = layui.layer;

        var renderTable=function(){
            layer.load(2);
            treetable.render({
                treeColIndex: 1,
                treeSpid: null,
                treeIdName: 'id',
                treePidName: 'pid',
                elem: '#permission',
                url: '/passport/permission/list',
                page: false,
                cols: [
                    [
                        {type: 'numbers'},
                        {field: 'name', minWidth: 200, title: '权限名称'},
                        {field: 'url', title: '菜单url'},
                        {
                            field: 'type', width: 80, align: 'center', templet: function (d) {
                                if (d.type == 'MENU') {
                                    return '<span class="layui-badge layui-bg-green">菜单</span>';
                                } else if (d.type == 'FUNC') {
                                    return '<span class="layui-badge layui-bg-blue">功能</span>';
                                } else if (d.type == 'TABS') {
                                    return '<span class="layui-badge-rim">选项卡</span>';
                                }
                            }, title: '类型'
                        },
                        {templet: '#oper-col', title: 'oper'},
                    ]
                ],
                done: function () {
                    layer.closeAll('loading');
                }
            });
        };
       renderTable();
        var active = {
        };
        form.on("submit(permissionFormSubmit)", function (data) {
            $.ajax({
                url: '/passport/permission/add',
                method: 'POST',
                data: data.field,
                success: function (data) {
                    if (data.code >= 0) {
                        layer.closeAll();
                        renderTable();
                        layer.msg(data.msg, {time: 1000});
                    } else {
                        layer.msg(data.msg);
                    }
                }
            });
            return false;
        });
        table.on('tool(permission)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;

            if (layEvent === 'del') {
                layer.msg('删除' + data.id);
            } else if (layEvent === 'edit') {
                layer.msg('修改' + data.id);
            } else if (layEvent == 'addChild') {
                $("#permissionForm input[name='pid']").val(data.id);
                console.log(data.type);
                var type;
                if (data.pid==null&&data.type=='MENU'){
                    type='MENU';
                }else if (data.type=='MENU'){
                    type='TABS';
                } else if (data.type=='TABS'){
                    type='FUNC';
                }else {
                    layer.msg("不支持的操作", {time: 1000});
                    return;
                }
                $("#permissionForm input[name='permissionType']").val(type);
                layer.open({
                    type: 1
                    , title: ['资源创建', 'font-size:18px;']
                    , closeBtn: 1
                    , area: ['450px', '300px']
                    , maxmin: true  //最大最小化
                    , id: 'LAY_layui_permissionForm' //设定一个id，防止重复弹出
                    , content: $('#permissionForm')
                    , resize: true
                    , shadeClose: true
                });
            }
        });
        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>